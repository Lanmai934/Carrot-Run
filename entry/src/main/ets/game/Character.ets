import { GameConfig } from '../common/GameConfig';

// è§’è‰²çŠ¶æ€æšä¸¾
export enum CharacterState {
  RUNNING = 'running',
  JUMPING = 'jumping',
  SLIDING = 'sliding',
  FALLING = 'falling',
  DEAD = 'dead'
}

// è§’è‰²æŠ€èƒ½æšä¸¾
export enum CharacterSkill {
  SPEED_BOOST = 'speed_boost',
  DOUBLE_JUMP = 'double_jump',
  SHIELD = 'shield',
  COIN_MAGNET = 'coin_magnet'
}

// è§’è‰²å±æ€§æ¥å£
export interface CharacterAttributes {
  id: string;
  name: string;
  emoji: string;
  speedMultiplier: number;
  jumpMultiplier: number;
  specialSkill: CharacterSkill;
  unlockCost: number;
  description: string;
}

// èåœè§’è‰²ç±»
export class CarrotCharacter {
  // åŸºç¡€å±æ€§
  public x: number;
  public y: number;
  public width: number;
  public height: number;
  public velocityX: number;
  public velocityY: number;
  
  // è§’è‰²çŠ¶æ€
  public state: CharacterState;
  public isOnGround: boolean;
  public canDoubleJump: boolean;
  public hasUsedDoubleJump: boolean;
  
  // è§’è‰²å±æ€§
  public attributes: CharacterAttributes;
  
  // æŠ€èƒ½çŠ¶æ€
  public activeSkills: Map<CharacterSkill, number>; // æŠ€èƒ½ID -> å‰©ä½™æ—¶é—´
  public isInvincible: boolean;
  public invincibilityTime: number;
  
  // åŠ¨ç”»ç›¸å…³
  public animationFrame: number;
  public animationTimer: number;
  public animationSpeed: number;

  constructor(attributes: CharacterAttributes) {
    // åˆå§‹åŒ–ä½ç½®å’Œå¤§å°
    this.x = GameConfig.CARROT_START_X;
    this.y = GameConfig.CARROT_START_Y;
    this.width = GameConfig.CARROT_WIDTH;
    this.height = GameConfig.CARROT_HEIGHT;
    
    // åˆå§‹åŒ–é€Ÿåº¦
    this.velocityX = 0;
    this.velocityY = 0;
    
    // åˆå§‹åŒ–çŠ¶æ€
    this.state = CharacterState.RUNNING;
    this.isOnGround = true;
    this.canDoubleJump = false;
    this.hasUsedDoubleJump = false;
    
    // è®¾ç½®è§’è‰²å±æ€§
    this.attributes = attributes;
    
    // åˆå§‹åŒ–æŠ€èƒ½çŠ¶æ€
    this.activeSkills = new Map();
    this.isInvincible = false;
    this.invincibilityTime = 0;
    
    // åˆå§‹åŒ–åŠ¨ç”»
    this.animationFrame = 0;
    this.animationTimer = 0;
    this.animationSpeed = 100; // æ¯«ç§’
  }

  // æ›´æ–°è§’è‰²çŠ¶æ€
  public update(deltaTime: number): void {
    this.updatePhysics(deltaTime);
    this.updateSkills(deltaTime);
    this.updateAnimation(deltaTime);
    this.updateInvincibility(deltaTime);
  }

  // æ›´æ–°ç‰©ç†çŠ¶æ€
  private updatePhysics(deltaTime: number): void {
    // åº”ç”¨é‡åŠ›
    if (!this.isOnGround) {
      this.velocityY += GameConfig.GRAVITY;
    }
    
    // æ›´æ–°ä½ç½®
    this.x += this.velocityX * deltaTime;
    this.y += this.velocityY * deltaTime;
    
    // æ£€æŸ¥åœ°é¢ç¢°æ’
    if (this.y >= GameConfig.GROUND_LEVEL - this.height) {
      this.y = GameConfig.GROUND_LEVEL - this.height;
      this.velocityY = 0;
      this.isOnGround = true;
      this.hasUsedDoubleJump = false;
      
      if (this.state === CharacterState.JUMPING || this.state === CharacterState.FALLING) {
        this.state = CharacterState.RUNNING;
      }
    } else {
      this.isOnGround = false;
      if (this.velocityY > 0 && this.state !== CharacterState.SLIDING) {
        this.state = CharacterState.FALLING;
      }
    }
    
    // é™åˆ¶è§’è‰²åœ¨å±å¹•å†…
    if (this.x < 0) {
      this.x = 0;
    } else if (this.x > GameConfig.GAME_WIDTH - this.width) {
      this.x = GameConfig.GAME_WIDTH - this.width;
    }
  }

  // æ›´æ–°æŠ€èƒ½çŠ¶æ€
  private updateSkills(deltaTime: number): void {
    // æ›´æ–°æ¿€æ´»æŠ€èƒ½çš„å‰©ä½™æ—¶é—´
    for (const [skill, remainingTime] of this.activeSkills) {
      const newTime = remainingTime - deltaTime;
      if (newTime <= 0) {
        this.activeSkills.delete(skill);
        this.onSkillExpired(skill);
      } else {
        this.activeSkills.set(skill, newTime);
      }
    }
    
    // æ£€æŸ¥äºŒæ®µè·³æŠ€èƒ½
    this.canDoubleJump = this.hasSkill(CharacterSkill.DOUBLE_JUMP) || 
                        this.attributes.specialSkill === CharacterSkill.DOUBLE_JUMP;
  }

  // æ›´æ–°åŠ¨ç”»
  private updateAnimation(deltaTime: number): void {
    this.animationTimer += deltaTime;
    if (this.animationTimer >= this.animationSpeed) {
      this.animationFrame = (this.animationFrame + 1) % 4; // 4å¸§åŠ¨ç”»
      this.animationTimer = 0;
    }
  }

  // æ›´æ–°æ— æ•ŒçŠ¶æ€
  private updateInvincibility(deltaTime: number): void {
    if (this.isInvincible) {
      this.invincibilityTime -= deltaTime;
      if (this.invincibilityTime <= 0) {
        this.isInvincible = false;
        this.invincibilityTime = 0;
      }
    }
  }

  // è·³è·ƒ
  public jump(): boolean {
    if (this.isOnGround) {
      this.velocityY = GameConfig.JUMP_FORCE * this.attributes.jumpMultiplier;
      this.state = CharacterState.JUMPING;
      this.isOnGround = false;
      return true;
    } else if (this.canDoubleJump && !this.hasUsedDoubleJump) {
      this.velocityY = GameConfig.JUMP_FORCE * this.attributes.jumpMultiplier * 0.8;
      this.state = CharacterState.JUMPING;
      this.hasUsedDoubleJump = true;
      return true;
    }
    return false;
  }

  // æ»‘è¡Œ
  public slide(): boolean {
    if (this.isOnGround && this.state !== CharacterState.SLIDING) {
      this.state = CharacterState.SLIDING;
      this.height = GameConfig.CARROT_HEIGHT * 0.6; // é™ä½é«˜åº¦
      this.y = GameConfig.GROUND_LEVEL - this.height;
      
      // æ»‘è¡ŒæŒç»­æ—¶é—´
      setTimeout(() => {
        if (this.state === CharacterState.SLIDING) {
          this.state = CharacterState.RUNNING;
          this.height = GameConfig.CARROT_HEIGHT;
          this.y = GameConfig.GROUND_LEVEL - this.height;
        }
      }, 800);
      
      return true;
    }
    return false;
  }

  // æ¿€æ´»æŠ€èƒ½
  public activateSkill(skill: CharacterSkill, duration: number): void {
    this.activeSkills.set(skill, duration);
    this.onSkillActivated(skill);
  }

  // æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æŠ€èƒ½
  public hasSkill(skill: CharacterSkill): boolean {
    return this.activeSkills.has(skill);
  }

  // æŠ€èƒ½æ¿€æ´»å›è°ƒ
  private onSkillActivated(skill: CharacterSkill): void {
    switch (skill) {
      case CharacterSkill.SHIELD:
        this.isInvincible = true;
        this.invincibilityTime = this.activeSkills.get(skill) || 0;
        break;
      case CharacterSkill.SPEED_BOOST:
        // é€Ÿåº¦æå‡åœ¨æ¸²æŸ“æ—¶å¤„ç†
        break;
      case CharacterSkill.COIN_MAGNET:
        // ç£é“æ•ˆæœåœ¨é“å…·æ”¶é›†æ—¶å¤„ç†
        break;
      case CharacterSkill.DOUBLE_JUMP:
        this.canDoubleJump = true;
        break;
    }
  }

  // æŠ€èƒ½è¿‡æœŸå›è°ƒ
  private onSkillExpired(skill: CharacterSkill): void {
    switch (skill) {
      case CharacterSkill.SHIELD:
        if (!this.hasSkill(CharacterSkill.SHIELD)) {
          this.isInvincible = false;
          this.invincibilityTime = 0;
        }
        break;
      case CharacterSkill.DOUBLE_JUMP:
        this.canDoubleJump = this.attributes.specialSkill === CharacterSkill.DOUBLE_JUMP;
        break;
    }
  }

  // å—åˆ°ä¼¤å®³
  public takeDamage(): boolean {
    if (this.isInvincible) {
      return false; // æ— æ•ŒçŠ¶æ€ï¼Œä¸å—ä¼¤å®³
    }
    
    this.state = CharacterState.DEAD;
    return true; // å—åˆ°ä¼¤å®³
  }

  // è·å–å½“å‰é€Ÿåº¦å€æ•°
  public getSpeedMultiplier(): number {
    let multiplier = this.attributes.speedMultiplier;
    
    if (this.hasSkill(CharacterSkill.SPEED_BOOST)) {
      multiplier *= 1.5; // é€Ÿåº¦æå‡50%
    }
    
    return multiplier;
  }

  // è·å–ç¢°æ’ç›’
  public getBounds(): { x: number, y: number, width: number, height: number } {
    return {
      x: this.x,
      y: this.y,
      width: this.width,
      height: this.height
    };
  }

  // é‡ç½®è§’è‰²çŠ¶æ€
  public reset(): void {
    this.x = GameConfig.CARROT_START_X;
    this.y = GameConfig.CARROT_START_Y;
    this.velocityX = 0;
    this.velocityY = 0;
    this.state = CharacterState.RUNNING;
    this.isOnGround = true;
    this.canDoubleJump = false;
    this.hasUsedDoubleJump = false;
    this.activeSkills.clear();
    this.isInvincible = false;
    this.invincibilityTime = 0;
    this.height = GameConfig.CARROT_HEIGHT;
  }

  // ç»˜åˆ¶è§’è‰²
  public draw(context: CanvasRenderingContext2D): void {
    if (!context) return;

    // ä¿å­˜ç”»å¸ƒçŠ¶æ€
    context.save();

    // å¦‚æœæ— æ•ŒçŠ¶æ€ï¼Œæ·»åŠ é—ªçƒæ•ˆæœ
    if (this.isInvincible && Math.floor(Date.now() / 100) % 2) {
      context.globalAlpha = 0.5;
    }

    // ç»˜åˆ¶è§’è‰²ï¼ˆä½¿ç”¨emojiä½œä¸ºç®€å•çš„è§†è§‰è¡¨ç¤ºï¼‰
    context.font = `${this.height}px Arial`;
    context.textAlign = 'center';
    context.textBaseline = 'bottom';
    
    // æ ¹æ®çŠ¶æ€è°ƒæ•´è§’è‰²æ˜¾ç¤º
    let displayEmoji = this.attributes.emoji;
    if (this.state === CharacterState.JUMPING) {
      displayEmoji = 'ğŸ¥•'; // è·³è·ƒçŠ¶æ€
    } else if (this.state === CharacterState.SLIDING) {
      displayEmoji = 'ğŸ¥•'; // æ»‘è¡ŒçŠ¶æ€
    }
    
    context.fillText(
      displayEmoji,
      this.x + this.width / 2,
      this.y + this.height
    );

    // ç»˜åˆ¶æŠ€èƒ½æ•ˆæœ
    this.drawSkillEffects(context);

    // æ¢å¤ç”»å¸ƒçŠ¶æ€
    context.restore();
  }

  // ç»˜åˆ¶æŠ€èƒ½æ•ˆæœ
  private drawSkillEffects(context: CanvasRenderingContext2D): void {
    const centerX = this.x + this.width / 2;
    const centerY = this.y + this.height / 2;

    // ç»˜åˆ¶æŠ¤ç›¾æ•ˆæœ
    if (this.hasSkill(CharacterSkill.SHIELD)) {
      context.strokeStyle = '#00FFFF';
      context.lineWidth = 3;
      context.beginPath();
      context.arc(centerX, centerY, this.width / 2 + 5, 0, Math.PI * 2);
      context.stroke();
    }

    // ç»˜åˆ¶é€Ÿåº¦æå‡æ•ˆæœ
    if (this.hasSkill(CharacterSkill.SPEED_BOOST)) {
      context.fillStyle = '#FFFF00';
      context.fillText('ğŸ’¨', centerX + this.width / 2, centerY);
    }

    // ç»˜åˆ¶ç£é“æ•ˆæœ
    if (this.hasSkill(CharacterSkill.COIN_MAGNET)) {
      context.fillStyle = '#FF00FF';
      context.fillText('ğŸ§²', centerX, centerY - this.height / 2);
    }
  }
}

// é¢„å®šä¹‰çš„è§’è‰²é…ç½®
export const CHARACTER_CONFIGS: { [key: string]: CharacterAttributes } = {
  SPEED_CARROT: {
    id: 'SPEED_CARROT',
    name: 'é€Ÿåº¦èåœ',
    emoji: 'ğŸ¥•',
    speedMultiplier: 1.2,
    jumpMultiplier: 1.0,
    specialSkill: CharacterSkill.SPEED_BOOST,
    unlockCost: 0,
    description: 'è·‘å¾—æ›´å¿«çš„èåœï¼Œé€‚åˆè¿½æ±‚é€Ÿåº¦çš„ç©å®¶'
  },
  JUMP_CARROT: {
    id: 'JUMP_CARROT',
    name: 'è·³è·ƒèåœ',
    emoji: 'ğŸ¥•',
    speedMultiplier: 1.0,
    jumpMultiplier: 1.3,
    specialSkill: CharacterSkill.DOUBLE_JUMP,
    unlockCost: 100,
    description: 'è·³å¾—æ›´é«˜çš„èåœï¼Œå¯ä»¥è¿›è¡ŒäºŒæ®µè·³'
  },
  TANK_CARROT: {
    id: 'TANK_CARROT',
    name: 'å¦å…‹èåœ',
    emoji: 'ğŸ¥•',
    speedMultiplier: 0.8,
    jumpMultiplier: 0.9,
    specialSkill: CharacterSkill.SHIELD,
    unlockCost: 200,
    description: 'é˜²å¾¡åŠ›å¼ºçš„èåœï¼Œå¼€å±€è‡ªå¸¦æŠ¤ç›¾'
  },
  LUCKY_CARROT: {
    id: 'LUCKY_CARROT',
    name: 'å¹¸è¿èåœ',
    emoji: 'ğŸ¥•',
    speedMultiplier: 1.0,
    jumpMultiplier: 1.0,
    specialSkill: CharacterSkill.COIN_MAGNET,
    unlockCost: 150,
    description: 'å¹¸è¿çš„èåœï¼Œå¼€å±€è‡ªå¸¦å¸é“çŸ³æ•ˆæœ'
  }
};