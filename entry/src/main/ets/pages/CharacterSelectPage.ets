import { GameStateManager, GameStateType } from '../common/GameState';
import { GameDataManager } from '../common/GameData';
import { GameConfig } from '../common/GameConfig';
import { CHARACTER_CONFIGS, CharacterAttributes } from '../game/Character';
import { AudioHelper } from '../game/AudioSystem';
import router from '@ohos.router';

@Entry
@Component
struct CharacterSelectPage {
  @State selectedCharacterId: string = 'SPEED_CARROT';
  @State playerCoins: number = 0;
  @State unlockedCharacters: string[] = [];
  @State showUnlockDialog: boolean = false;
  @State unlockingCharacter: CharacterAttributes | null = null;

  private gameStateManager: GameStateManager = GameStateManager.getInstance();
  private gameDataManager: GameDataManager = GameDataManager.getInstance();

  aboutToAppear() {
    this.loadPlayerData();
  }

  // åŠ è½½ç©å®¶æ•°æ®
  private loadPlayerData(): void {
    const gameData = this.gameDataManager.getGameData();
    this.playerCoins = gameData.totalCoins;
    this.unlockedCharacters = gameData.unlockedCharacters;
    this.selectedCharacterId = gameData.selectedCharacter;
  }

  // é€‰æ‹©è§’è‰²
  private selectCharacter(characterId: string): void {
    if (this.unlockedCharacters.includes(characterId)) {
      // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
      AudioHelper.playButtonClick();
      this.selectedCharacterId = characterId;
      this.gameDataManager.selectCharacter(characterId);
    }
  }

  // å°è¯•è§£é”è§’è‰²
  private tryUnlockCharacter(character: CharacterAttributes): void {
    if (this.unlockedCharacters.includes(character.id)) {
      return; // å·²è§£é”
    }

    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
    AudioHelper.playButtonClick();
    
    if (this.playerCoins >= character.unlockCost) {
      this.unlockingCharacter = character;
      this.showUnlockDialog = true;
    } else {
      // é‡‘å¸ä¸è¶³æç¤º
      // TODO: æ˜¾ç¤ºé‡‘å¸ä¸è¶³çš„æç¤º
    }
  }

  // ç¡®è®¤è§£é”è§’è‰²
  private confirmUnlock(): void {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
    AudioHelper.playButtonClick();
    
    if (this.unlockingCharacter && this.playerCoins >= this.unlockingCharacter.unlockCost) {
      // æ‰£é™¤é‡‘å¸
      this.gameDataManager.addCoins(-this.unlockingCharacter.unlockCost);
      
      // è§£é”è§’è‰²
      this.gameDataManager.unlockCharacter(this.unlockingCharacter.id);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.unlockedCharacters.push(this.unlockingCharacter.id);
      this.playerCoins -= this.unlockingCharacter.unlockCost;
      
      // è‡ªåŠ¨é€‰æ‹©æ–°è§£é”çš„è§’è‰²
      this.selectCharacter(this.unlockingCharacter.id);
    }
    
    this.showUnlockDialog = false;
    this.unlockingCharacter = null;
  }

  // å–æ¶ˆè§£é”
  private cancelUnlock(): void {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
    AudioHelper.playButtonClick();
    this.showUnlockDialog = false;
    this.unlockingCharacter = null;
  }

  // è¿”å›ä¸»èœå•
  private backToMenu(): void {
    // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
    AudioHelper.playButtonClick();
    this.gameStateManager.changeState(GameStateType.MENU);
    router.back();
  }

  // è·å–è§’è‰²çŠ¶æ€æ–‡æœ¬
  private getCharacterStatusText(character: CharacterAttributes): string {
    if (this.unlockedCharacters.includes(character.id)) {
      return character.id === this.selectedCharacterId ? 'å·²é€‰æ‹©' : 'å·²è§£é”';
    } else {
      return `è§£é”éœ€è¦ ${character.unlockCost} é‡‘å¸`;
    }
  }

  // è·å–è§’è‰²çŠ¶æ€é¢œè‰²
  private getCharacterStatusColor(character: CharacterAttributes): string {
    if (this.unlockedCharacters.includes(character.id)) {
      return character.id === this.selectedCharacterId ? GameConfig.COLORS.PRIMARY : GameConfig.COLORS.SECONDARY;
    } else {
      return this.playerCoins >= character.unlockCost ? '#4CAF50' : '#999999';
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Row() {
          Button('â† è¿”å›')
            .backgroundColor('transparent')
            .fontColor(GameConfig.COLORS.TEXT)
            .onClick(() => this.backToMenu())

          Blank()

          Text('è§’è‰²é€‰æ‹©')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(GameConfig.COLORS.TEXT)

          Blank()

          Text(`ğŸ’° ${this.playerCoins}`)
            .fontSize(18)
            .fontColor(GameConfig.COLORS.TEXT)
            .backgroundColor('rgba(0,0,0,0.3)')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(15)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 20, bottom: 20 })

        // è§’è‰²åˆ—è¡¨
        Scroll() {
          Column({ space: 16 }) {
            ForEach(Object.values(CHARACTER_CONFIGS), (character: CharacterAttributes) => {
              this.CharacterCard(character)
            })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)

        // åº•éƒ¨ç¡®è®¤æŒ‰é’®
        Button('ç¡®è®¤é€‰æ‹©')
          .width('80%')
          .height(50)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .backgroundColor(GameConfig.COLORS.PRIMARY)
          .borderRadius(25)
          .margin({ bottom: 30 })
          .onClick(() => this.backToMenu())
      }
      .width('100%')
      .height('100%')
      .backgroundColor(GameConfig.COLORS.BACKGROUND)

      // è§£é”ç¡®è®¤å¯¹è¯æ¡†
      if (this.showUnlockDialog && this.unlockingCharacter) {
        Column() {
          Column() {
            Text('è§£é”è§’è‰²')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 16 })

            Text(`${this.unlockingCharacter.emoji}`)
              .fontSize(60)
              .margin({ bottom: 12 })

            Text(this.unlockingCharacter.name)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 8 })

            Text(this.unlockingCharacter.description)
              .fontSize(14)
              .fontColor('#666666')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 16 })

            Text(`éœ€è¦ ${this.unlockingCharacter.unlockCost} é‡‘å¸`)
              .fontSize(16)
              .fontColor(GameConfig.COLORS.PRIMARY)
              .margin({ bottom: 20 })

            Row({ space: 12 }) {
              Button('å–æ¶ˆ')
                .width(80)
                .height(40)
                .backgroundColor('#999999')
                .onClick(() => this.cancelUnlock())

              Button('ç¡®è®¤è§£é”')
                .width(100)
                .height(40)
                .backgroundColor(GameConfig.COLORS.PRIMARY)
                .onClick(() => this.confirmUnlock())
            }
          }
          .backgroundColor('#FFFFFF')
          .padding(24)
          .borderRadius(12)
          .width('80%')
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }

  // è§’è‰²å¡ç‰‡ç»„ä»¶
  @Builder CharacterCard(character: CharacterAttributes) {
    Column() {
      Row() {
        // è§’è‰²å›¾æ ‡
        Column() {
          Text(character.emoji)
            .fontSize(50)
            .margin({ bottom: 8 })
        }
        .width(80)
        .alignItems(HorizontalAlign.Center)

        // è§’è‰²ä¿¡æ¯
        Column({ space: 4 }) {
          Text(character.name)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Text(character.description)
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // å±æ€§æ˜¾ç¤º
          Row({ space: 12 }) {
            Text(`é€Ÿåº¦: ${(character.speedMultiplier * 100).toFixed(0)}%`)
              .fontSize(12)
              .fontColor('#888888')

            Text(`è·³è·ƒ: ${(character.jumpMultiplier * 100).toFixed(0)}%`)
              .fontSize(12)
              .fontColor('#888888')
          }
          .margin({ top: 4 })

          // ç‰¹æ®ŠæŠ€èƒ½
          Text(`ç‰¹æŠ€: ${this.getSkillName(character.specialSkill)}`)
            .fontSize(12)
            .fontColor(GameConfig.COLORS.PRIMARY)
            .margin({ top: 2 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // çŠ¶æ€æŒ‰é’®
        Column() {
          if (this.unlockedCharacters.includes(character.id)) {
            if (character.id === this.selectedCharacterId) {
              Text('âœ“ å·²é€‰æ‹©')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .backgroundColor(GameConfig.COLORS.PRIMARY)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .borderRadius(12)
            } else {
              Button('é€‰æ‹©')
                .width(60)
                .height(32)
                .fontSize(14)
                .backgroundColor(GameConfig.COLORS.SECONDARY)
                .onClick(() => this.selectCharacter(character.id))
            }
          } else {
            Button('è§£é”')
              .width(60)
              .height(32)
              .fontSize(14)
              .backgroundColor(this.playerCoins >= character.unlockCost ? '#4CAF50' : '#999999')
              .enabled(this.playerCoins >= character.unlockCost)
              .onClick(() => this.tryUnlockCharacter(character))
          }
        }
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 2 })
  }

  // è·å–æŠ€èƒ½åç§°
  private getSkillName(skill: string): string {
    switch (skill) {
      case 'speed_boost': return 'é€Ÿåº¦å†²åˆº';
      case 'double_jump': return 'äºŒæ®µè·³';
      case 'shield': return 'æŠ¤ç›¾';
      case 'coin_magnet': return 'å¸é“çŸ³';
      default: return 'æœªçŸ¥æŠ€èƒ½';
    }
  }
}