import { GameStateManager, GameStateType } from '../common/GameState';
import { GameDataManager } from '../common/GameData';
import { GameConfig } from '../common/GameConfig';
import { Character } from '../common/Character';
import { GameWorld } from '../common/GameWorld';
import { physicsEngine } from '../common/PhysicsEngine';
import { levelManager, MapTheme } from '../common/LevelSystem'
import { ItemType } from '../common/ItemSystem';
import { GameButton, GamePanel, GameIcon, ButtonStyle, ButtonSize } from '../common/UIComponents'
import { audioManager, AudioHelper, AudioType } from '../game/AudioSystem'
import router from '@ohos.router';

@Entry
@Component
struct GamePage {
  @State gameScore: number = 0;
  @State gameDistance: number = 0;
  @State gameCoins: number = 0;
  @State isPaused: boolean = false;
  @State gameOver: boolean = false;
  @State health: number = 3;
  
  private gameStateManager: GameStateManager = GameStateManager.getInstance();
  private gameDataManager: GameDataManager = GameDataManager.getInstance();
  private gameLoopTimer: number = -1;
  private canvasContext: CanvasRenderingContext2D | null = null;
  private character: Character | null = null;
  private gameWorld: GameWorld | null = null;
  private lastTime: number = 0;

  aboutToAppear() {
    this.gameStateManager.changeState(GameStateType.PLAYING);
    this.initGame();
    this.startGameLoop();
    // å¼€å§‹èƒŒæ™¯éŸ³ä¹
    AudioHelper.startBackgroundMusic()
  }

  aboutToDisappear() {
    this.stopGameLoop();
    // åœæ­¢èƒŒæ™¯éŸ³ä¹
    AudioHelper.stopBackgroundMusic()
  }

  // åˆå§‹åŒ–æ¸¸æˆ
  private initGame(): void {
    // åˆå§‹åŒ–å…³å¡ç®¡ç†å™¨
    levelManager.initialize()
    levelManager.loadLevel(1) // åŠ è½½ç¬¬ä¸€å…³
    
    // èŽ·å–é€‰ä¸­çš„è§’è‰²
    const playerData = this.gameDataManager.getPlayerData();
    this.character = new Character(playerData.selectedCharacter);
    this.health = this.character.currentHealth;
    
    // åˆ›å»ºæ¸¸æˆä¸–ç•Œ
    this.gameWorld = new GameWorld(physicsEngine);
    this.gameWorld.setCharacter(this.character);
    
    this.lastTime = Date.now();
  }

  // å¼€å§‹æ¸¸æˆå¾ªçŽ¯
  private startGameLoop(): void {
    this.gameLoopTimer = setInterval(() => {
      if (!this.isPaused && !this.gameOver) {
        this.updateGame();
        this.renderGame();
      }
    }, 1000 / GameConfig.FPS);
  }

  // åœæ­¢æ¸¸æˆå¾ªçŽ¯
  private stopGameLoop(): void {
    if (this.gameLoopTimer !== -1) {
      clearInterval(this.gameLoopTimer);
      this.gameLoopTimer = -1;
    }
  }

  // æ›´æ–°æ¸¸æˆé€»è¾‘
  private updateGame(): void {
    const currentTime = Date.now();
    const deltaTime = (currentTime - this.lastTime) / 1000; // è½¬æ¢ä¸ºç§’
    this.lastTime = currentTime;
    
    // æ›´æ–°æ¸¸æˆä¸–ç•Œ
    if (this.gameWorld) {
      this.gameWorld.update(deltaTime);
      this.gameScore = this.gameWorld.getScore();
      this.gameDistance = this.gameWorld.getDistance();
      this.gameCoins = this.gameWorld.getCoins();
    }
    
    // æ›´æ–°è§’è‰²çŠ¶æ€
    if (this.character) {
      this.health = this.character.currentHealth;
      
      // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
      if (this.character.state === 'dead') {
        this.endGame();
      }
    }
  }

  // æ¸²æŸ“æ¸¸æˆç”»é¢
  private renderGame(): void {
    if (!this.canvasContext || !this.gameWorld) return;

    // æ¸…ç©ºç”»å¸ƒ
    this.canvasContext.clearRect(0, 0, GameConfig.GAME_WIDTH, GameConfig.GAME_HEIGHT);
    
    // æ¸²æŸ“æ¸¸æˆä¸–ç•Œ
    this.gameWorld.render(this.canvasContext);
  }

  // ç»˜åˆ¶èƒŒæ™¯
  private drawBackground(): void {
    if (!this.canvasContext) return;

    // ç»˜åˆ¶å¤©ç©º
    this.canvasContext.fillStyle = GameConfig.COLORS.BACKGROUND;
    this.canvasContext.fillRect(0, 0, GameConfig.GAME_WIDTH, GameConfig.GROUND_LEVEL);
    
    // ç»˜åˆ¶åœ°é¢
    this.canvasContext.fillStyle = GameConfig.COLORS.GROUND;
    this.canvasContext.fillRect(0, GameConfig.GROUND_LEVEL, GameConfig.GAME_WIDTH, GameConfig.GAME_HEIGHT - GameConfig.GROUND_LEVEL);
  }

  // æš‚åœæ¸¸æˆ
  private pauseGame(): void {
    this.isPaused = true;
    this.gameStateManager.changeState(GameStateType.PAUSED);
    // æš‚åœæ‰€æœ‰éŸ³æ•ˆ
    audioManager.pauseAll();
  }

  // ç»§ç»­æ¸¸æˆ
  private resumeGame(): void {
    this.isPaused = false;
    this.gameStateManager.changeState(GameStateType.PLAYING);
    // æ¢å¤æ‰€æœ‰éŸ³æ•ˆ
    audioManager.resumeAll();
  }

  // æ¸¸æˆç»“æŸ
  private endGame(): void {
    this.gameOver = true;
    this.stopGameLoop();
    this.gameStateManager.changeState(GameStateType.GAME_OVER);
    // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
    AudioHelper.playGameOver();
    
    // ä¿å­˜æ¸¸æˆæ•°æ®
    this.gameDataManager.updateHighScore(this.gameScore);
    this.gameDataManager.addDistance(this.gameDistance);
    this.gameDataManager.addCoins(this.gameCoins);
    this.gameDataManager.incrementGamesPlayed();
  }

  // è¿”å›žä¸»èœå•
  private backToMenu(): void {
    this.gameStateManager.changeState(GameStateType.MENU);
    router.back();
  }

  // é‡æ–°å¼€å§‹æ¸¸æˆ
  private restartGame(): void {
    this.gameScore = 0;
    this.gameDistance = 0;
    this.gameCoins = 0;
    this.gameOver = false;
    this.isPaused = false;
    this.health = 3;
    this.gameStateManager.changeState(GameStateType.PLAYING);
    this.initGame();
    this.startGameLoop();
  }

  // é“å…·æ•ˆæžœå›¾æ ‡ç»„ä»¶
  @Builder EffectIcon(effectType: ItemType) {
    Stack() {
      // èƒŒæ™¯åœ†åœˆ
      Circle({ width: 40, height: 40 })
        .fill(this.getEffectColor(effectType))
        .opacity(0.8)
      
      // æ•ˆæžœå›¾æ ‡
      Text(this.getEffectSymbol(effectType))
        .fontSize(20)
        .fontColor(Color.White)
        .fontWeight(FontWeight.Bold)
      
      // å‰©ä½™æ—¶é—´æ˜¾ç¤º
      if (this.character) {
        const remainingTime = this.character.getEffectRemainingTime(effectType)
        if (remainingTime > 0) {
          Text(`${Math.ceil(remainingTime / 1000)}`)
            .fontSize(10)
            .fontColor(Color.White)
            .position({ x: 25, y: -5 })
            .backgroundColor(Color.Red)
            .borderRadius(8)
            .padding({ left: 4, right: 4, top: 1, bottom: 1 })
        }
      }
    }
    .margin({ right: 8 })
  }
  
  private getEffectColor(effectType: ItemType): string {
    switch (effectType) {
      case ItemType.SPEED_BOOST: return '#FF4500'
      case ItemType.SHIELD: return '#4169E1'
      case ItemType.MAGNET: return '#DC143C'
      case ItemType.JUMP_BOOST: return '#32CD32'
      case ItemType.DOUBLE_SCORE: return '#9932CC'
      case ItemType.INVINCIBLE: return '#FFD700'
      case ItemType.SLOW_TIME: return '#00CED1'
      default: return '#808080'
    }
  }
  
  private getEffectSymbol(effectType: ItemType): string {
    switch (effectType) {
      case ItemType.SPEED_BOOST: return 'âš¡'
      case ItemType.SHIELD: return 'ðŸ›¡'
      case ItemType.MAGNET: return 'ðŸ§²'
      case ItemType.JUMP_BOOST: return 'â†‘'
      case ItemType.DOUBLE_SCORE: return 'Ã—2'
      case ItemType.INVINCIBLE: return 'â˜…'
      case ItemType.SLOW_TIME: return 'â°'
      default: return '?'
    }
  }

  build() {
    Stack() {
      // æ¸¸æˆç”»å¸ƒ
      Canvas(this.canvasContext)
        .width(GameConfig.GAME_WIDTH)
        .height(GameConfig.GAME_HEIGHT)
        .backgroundColor(GameConfig.COLORS.BACKGROUND)
        .onReady(() => {
          // Canvaså‡†å¤‡å°±ç»ªåŽèŽ·å–ç»˜å›¾ä¸Šä¸‹æ–‡
          // this.canvasContext = context; // éœ€è¦åœ¨å®žé™…ä½¿ç”¨æ—¶èŽ·å–æ­£ç¡®çš„context
        })
        .gesture(
          // æ·»åŠ æ‰‹åŠ¿è¯†åˆ«ç”¨äºŽè·³è·ƒå’Œæ»‘è¡Œ
          TapGesture()
            .onAction(() => {
              if (!this.isPaused && !this.gameOver && this.character) {
                this.character.jump();
                // æ’­æ”¾è·³è·ƒéŸ³æ•ˆ
                AudioHelper.playJump()
              }
            })
        )

      // æ¸¸æˆUIè¦†ç›–å±‚
      Column() {
        // é¡¶éƒ¨ä¿¡æ¯æ 
        GamePanel({
          backgroundColor: 'rgba(0,0,0,0.3)',
          borderRadius: 20,
          padding: 12
        }) {
          Row() {
            // å…³å¡æ˜¾ç¤º
            Row() {
              GameIcon({ icon: 'ðŸŽ¯', size: 18 })
              Text(`${levelManager.getCurrentLevelId()}`)
                .fontSize(16)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
                .margin({ left: 4 })
            }
            
            Blank()
            
            // åˆ†æ•°æ˜¾ç¤º
            Row() {
              GameIcon({ icon: 'ðŸ†', size: 20 })
              Text(`${this.gameScore}`)
                .fontSize(18)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
                .margin({ left: 6 })
            }
            
            Blank()
            
            // é‡‘å¸æ˜¾ç¤º
            Row() {
              GameIcon({ icon: 'ðŸ’°', size: 18 })
              Text(`${this.gameCoins}`)
                .fontSize(16)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
                .margin({ left: 4 })
            }
            
            Blank()
            
            // ç”Ÿå‘½å€¼æ˜¾ç¤º
            Row() {
              GameIcon({ icon: 'â¤ï¸', size: 18 })
              Text(`${this.health}`)
                .fontSize(16)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Bold)
                .margin({ left: 4 })
            }
            
            Blank()
            
            // æš‚åœæŒ‰é’®
            GameButton({
              text: '',
              icon: 'â¸ï¸',
              style: ButtonStyle.TRANSPARENT,
              size: ButtonSize.SMALL,
              width: 40,
              height: 40,
              backgroundColor: 'rgba(0,0,0,0.5)',
              onClick: () => {
                AudioHelper.playButtonClick()
                this.pauseGame()
              }
            })
          }
          .width('100%')
        }
        .width('90%')
        .margin({ top: 10 })
        .alignSelf(ItemAlign.Center)

        Blank()

        // è·ç¦»æ˜¾ç¤º
        Text(`${Math.floor(this.gameDistance)}m`)
          .fontSize(20)
          .fontColor(GameConfig.COLORS.TEXT)
          .backgroundColor('rgba(0,0,0,0.5)')
          .padding(12)
          .borderRadius(12)
          .margin({ bottom: 20 })
          
        // é“å…·æ•ˆæžœæ˜¾ç¤ºåŒºåŸŸ
        Row() {
          ForEach(this.character?.getActiveEffects() || [], (effectType: ItemType) => {
            this.EffectIcon(effectType)
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .padding({ left: 20, top: 5 })
      }
      .width('100%')
      .height('100%')

      // æš‚åœèœå•
      if (this.isPaused && !this.gameOver) {
        Stack() {
          // åŠé€æ˜ŽèƒŒæ™¯
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.7)')
          
          // æš‚åœèœå•é¢æ¿
          GamePanel({
            backgroundColor: 'rgba(255,255,255,0.95)',
            borderRadius: 20,
            padding: 30
          }) {
            Column() {
              // æ ‡é¢˜
              Text('æ¸¸æˆæš‚åœ')
                .fontSize(32)
                .fontColor(GameConfig.COLORS.PRIMARY)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 30 })
              
              // å½“å‰æ¸¸æˆçŠ¶æ€
              Row() {
                Column() {
                  Text('åˆ†æ•°')
                    .fontSize(14)
                    .fontColor('#666')
                  Text(`${this.gameScore}`)
                    .fontSize(20)
                    .fontColor(GameConfig.COLORS.PRIMARY)
                    .fontWeight(FontWeight.Bold)
                }
                .margin({ right: 30 })
                
                Column() {
                  Text('é‡‘å¸')
                    .fontSize(14)
                    .fontColor('#666')
                  Text(`${this.gameCoins}`)
                    .fontSize(20)
                    .fontColor('#FFA500')
                    .fontWeight(FontWeight.Bold)
                }
                .margin({ right: 30 })
                
                Column() {
                  Text('å…³å¡')
                    .fontSize(14)
                    .fontColor('#666')
                  Text(`${levelManager.getCurrentLevelId()}`)
                    .fontSize(20)
                    .fontColor('#FF6B6B')
                    .fontWeight(FontWeight.Bold)
                }
              }
              .margin({ bottom: 30 })
              
              // æŒ‰é’®ç»„
              Column({ space: 16 }) {
                GameButton({
                  text: 'ç»§ç»­æ¸¸æˆ',
                  icon: 'â–¶ï¸',
                  style: ButtonStyle.PRIMARY,
                  size: ButtonSize.LARGE,
                  width: 220,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.resumeGame()
                  }
                })
                
                GameButton({
                  text: 'é‡æ–°å¼€å§‹',
                  icon: 'ðŸ”„',
                  style: ButtonStyle.SECONDARY,
                  size: ButtonSize.MEDIUM,
                  width: 200,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.restartGame()
                  }
                })
                
                GameButton({
                  text: 'è¿”å›žä¸»èœå•',
                  icon: 'ðŸ ',
                  style: ButtonStyle.TRANSPARENT,
                  size: ButtonSize.MEDIUM,
                  width: 200,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.backToMenu()
                  }
                })
              }
            }
          }
          .width(300)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }

      // æ¸¸æˆç»“æŸèœå•
      if (this.gameOver) {
        Stack() {
          // åŠé€æ˜ŽèƒŒæ™¯
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.8)')
          
          // æ¸¸æˆç»“æŸé¢æ¿
          GamePanel({
            backgroundColor: 'rgba(255,255,255,0.95)',
            borderRadius: 20,
            padding: 30
          }) {
            Column() {
              // æ ‡é¢˜
              Text('æ¸¸æˆç»“æŸ')
                .fontSize(32)
                .fontColor('#FF6B6B')
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 20 })
              
              // æ¸¸æˆç»“æžœç»Ÿè®¡
              Column({ space: 12 }) {
                Row() {
                  GameIcon({ icon: 'ðŸ†', size: 24 })
                  Text('æœ€ç»ˆåˆ†æ•°')
                    .fontSize(16)
                    .fontColor('#666')
                    .margin({ left: 8, right: 20 })
                  Text(`${this.gameScore}`)
                    .fontSize(20)
                    .fontColor(GameConfig.COLORS.PRIMARY)
                    .fontWeight(FontWeight.Bold)
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                
                Row() {
                  GameIcon({ icon: 'ðŸ’°', size: 24 })
                  Text('æ”¶é›†é‡‘å¸')
                    .fontSize(16)
                    .fontColor('#666')
                    .margin({ left: 8, right: 20 })
                  Text(`${this.gameCoins}`)
                    .fontSize(20)
                    .fontColor('#FFA500')
                    .fontWeight(FontWeight.Bold)
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                
                Row() {
                  GameIcon({ icon: 'ðŸŽ¯', size: 24 })
                  Text('åˆ°è¾¾å…³å¡')
                    .fontSize(16)
                    .fontColor('#666')
                    .margin({ left: 8, right: 20 })
                  Text(`${levelManager.getCurrentLevelId()}`)
                    .fontSize(20)
                    .fontColor('#FF6B6B')
                    .fontWeight(FontWeight.Bold)
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .width('100%')
              .padding(20)
              .backgroundColor('rgba(0,0,0,0.05)')
              .borderRadius(12)
              .margin({ bottom: 30 })
              
              // æŒ‰é’®ç»„
              Column({ space: 16 }) {
                GameButton({
                  text: 'é‡æ–°å¼€å§‹',
                  icon: 'ðŸ”„',
                  style: ButtonStyle.PRIMARY,
                  size: ButtonSize.LARGE,
                  width: 220,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.restartGame()
                  }
                })
                
                GameButton({
                  text: 'è¿”å›žä¸»èœå•',
                  icon: 'ðŸ ',
                  style: ButtonStyle.SECONDARY,
                  size: ButtonSize.MEDIUM,
                  width: 200,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.backToMenu()
                  }
                })
              }
            }
          }
          .width(320)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }
}