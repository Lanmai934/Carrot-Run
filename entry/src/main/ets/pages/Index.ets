import { GameStateManager, GameStateType } from '../common/GameState';
import { GameDataManager } from '../common/GameData';
import { GameConfig } from '../common/GameConfig'
import { GameButton, GamePanel, GameStatCard, ButtonStyle, ButtonSize } from '../common/UIComponents'
import { AudioHelper } from '../game/AudioSystem'
import router from '@ohos.router';

@Entry
@Component
struct Index {
  @State gameTitle: string = 'èåœè·‘é…·';
  @State playerCoins: number = 0;
  @State highScore: number = 0;
  private gameStateManager: GameStateManager = GameStateManager.getInstance();
  private gameDataManager: GameDataManager = GameDataManager.getInstance();

  aboutToAppear() {
    // åˆå§‹åŒ–æ¸¸æˆæ•°æ®
    this.loadPlayerData();
  }

  // åŠ è½½ç©å®¶æ•°æ®
  private loadPlayerData(): void {
    const gameData = this.gameDataManager.getGameData();
    this.playerCoins = gameData.totalCoins;
    this.highScore = gameData.highScore;
  }

  // å¼€å§‹æ¸¸æˆ
  private startGame(): void {
    this.gameStateManager.changeState(GameStateType.PLAYING);
    router.pushUrl({
      url: 'pages/GamePage'
    });
  }

  // è§’è‰²é€‰æ‹©
  private selectCharacter(): void {
    this.gameStateManager.changeState(GameStateType.CHARACTER_SELECT);
    router.pushUrl({
      url: 'pages/CharacterSelectPage'
    });
  }

  // è®¾ç½®é¡µé¢
  private openSettings(): void {
    this.gameStateManager.changeState(GameStateType.SETTINGS);
    router.pushUrl({
      url: 'pages/SettingsPage'
    });
  }

  private openShop() {
    // TODO: å®ç°å•†åº—é¡µé¢
    console.log('æ‰“å¼€å•†åº—é¡µé¢')
  }

  private openDailyTasks() {
    // TODO: å®ç°æ¯æ—¥ä»»åŠ¡é¡µé¢
    console.log('æ‰“å¼€æ¯æ—¥ä»»åŠ¡é¡µé¢')
  }

  build() {
    Stack() {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(GameConfig.COLORS.BACKGROUND)
      
      // ä¸»è¦å†…å®¹
      Column() {
        // æ ‡é¢˜åŒºåŸŸ
        Column() {
          Text('èåœè·‘é…·')
            .fontSize(48)
            .fontColor(GameConfig.COLORS.PRIMARY)
            .fontWeight(FontWeight.Bold)
            .textShadow({
              radius: 8,
              color: GameConfig.COLORS.PRIMARY + '40',
              offsetX: 0,
              offsetY: 4
            })
            .margin({ bottom: 10 })
          
          // èåœå›¾æ ‡
          Text('ğŸ¥•')
            .fontSize(64)
            .margin({ bottom: 20 })
            .animation({
              duration: 2000,
              curve: Curve.EaseInOut,
              iterations: -1,
              playMode: PlayMode.Alternate
            })
        }
        .margin({ top: 60, bottom: 30 })
        
        // ç©å®¶ç»Ÿè®¡ä¿¡æ¯
        Row() {
          GameStatCard({
            title: 'ç­‰çº§',
            value: this.playerData.level,
            icon: 'â­',
            color: '#FFD700'
          })
          
          GameStatCard({
            title: 'é‡‘å¸',
            value: this.playerData.coins,
            icon: 'ğŸ’°',
            color: '#FFA500'
          })
          .margin({ left: 12, right: 12 })
          
          GameStatCard({
            title: 'æœ€é«˜åˆ†',
            value: this.playerData.highScore,
            icon: 'ğŸ†',
            color: '#FF6B6B'
          })
        }
        .width('90%')
        .justifyContent(FlexAlign.SpaceEvenly)
        .margin({ bottom: 40 })
        
        // æŒ‰é’®ç»„
        Column() {
          GameButton({
            text: 'å¼€å§‹æ¸¸æˆ',
            icon: 'ğŸ®',
            style: ButtonStyle.PRIMARY,
            size: ButtonSize.LARGE,
            width: 220,
            onClick: () => {
              AudioHelper.playButtonClick()
              this.startGame()
            }
          })
          .margin({ bottom: 16 })
          
          GameButton({
            text: 'è§’è‰²é€‰æ‹©',
            icon: 'ğŸ¥•',
            style: ButtonStyle.SECONDARY,
            size: ButtonSize.MEDIUM,
            width: 200,
            onClick: () => {
              AudioHelper.playButtonClick()
              this.selectCharacter()
            }
          })
          .margin({ bottom: 16 })
          
          Row() {
            GameButton({
              text: 'è®¾ç½®',
              icon: 'âš™ï¸',
              style: ButtonStyle.TRANSPARENT,
              size: ButtonSize.MEDIUM,
              width: 95,
              onClick: () => {
                AudioHelper.playButtonClick()
                this.openSettings()
              }
            })
            .margin({ right: 10 })
            
            GameButton({
              text: 'å•†åº—',
              icon: 'ğŸ›’',
              style: ButtonStyle.TRANSPARENT,
              size: ButtonSize.MEDIUM,
              width: 95,
              onClick: () => {
                AudioHelper.playButtonClick()
                this.openShop()
              }
            })
          }
          .margin({ bottom: 16 })
        }
        .margin({ bottom: 30 })
        
        // æ¯æ—¥ä»»åŠ¡æç¤º
        if (this.playerData.dailyTasks.length > 0) {
          GameButton({
            text: 'æ¯æ—¥ä»»åŠ¡',
            icon: 'ğŸ“‹',
            style: ButtonStyle.WARNING,
            size: ButtonSize.SMALL,
            width: 120,
            onClick: () => {
              AudioHelper.playButtonClick()
              this.openDailyTasks()
            }
          })
          .margin({ bottom: 20 })
        }
        
        // ç‰ˆæœ¬ä¿¡æ¯
        Text('ç‰ˆæœ¬ 1.0.0')
          .fontSize(12)
          .fontColor('rgba(255,255,255,0.6)')
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
  }
}