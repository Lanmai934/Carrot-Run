import { GameStateManager, GameStateType } from '../common/GameState';
import { GameDataManager } from '../common/GameData';
import { GameConfig } from '../common/GameConfig'
import { GameButton, GamePanel, GameIcon, ButtonStyle, ButtonSize } from '../common/UIComponents'
import { audioManager, AudioHelper } from '../game/AudioSystem';
import router from '@ohos.router';

@Entry
@Component
struct SettingsPage {
  @State musicEnabled: boolean = true;
  @State sfxEnabled: boolean = true;
  @State vibrationEnabled: boolean = true;
  @State showResetDialog: boolean = false;

  private gameStateManager: GameStateManager = GameStateManager.getInstance();
  private gameDataManager: GameDataManager = GameDataManager.getInstance();

  aboutToAppear() {
    this.loadSettings();
  }

  // åŠ è½½è®¾ç½®
  private loadSettings(): void {
    const gameData = this.gameDataManager.getGameData();
    this.musicEnabled = gameData.musicEnabled;
    this.sfxEnabled = gameData.sfxEnabled;
    this.vibrationEnabled = gameData.vibrationEnabled;
    
    // åŒæ­¥åˆ°éŸ³æ•ˆç³»ç»Ÿ
    audioManager.setMusicEnabled(this.musicEnabled);
    audioManager.setSfxEnabled(this.sfxEnabled);
  }

  // ä¿å­˜è®¾ç½®
  private saveSettings(): void {
    this.gameDataManager.updateSettings({
      musicEnabled: this.musicEnabled,
      sfxEnabled: this.sfxEnabled,
      vibrationEnabled: this.vibrationEnabled
    });
  }

  // åˆ‡æ¢éŸ³ä¹è®¾ç½®
  private toggleMusic(): void {
    this.musicEnabled = !this.musicEnabled;
    this.saveSettings();
    // åŒæ­¥åˆ°éŸ³æ•ˆç³»ç»Ÿ
    audioManager.setMusicEnabled(this.musicEnabled);
    // æ’­æ”¾æŒ‰é’®éŸ³æ•ˆ
    AudioHelper.playButtonClick();
  }

  // åˆ‡æ¢éŸ³æ•ˆè®¾ç½®
  private toggleSfx(): void {
    this.sfxEnabled = !this.sfxEnabled;
    this.saveSettings();
    // åŒæ­¥åˆ°éŸ³æ•ˆç³»ç»Ÿ
    audioManager.setSfxEnabled(this.sfxEnabled);
    // æ’­æ”¾æŒ‰é’®éŸ³æ•ˆï¼ˆå¦‚æžœéŸ³æ•ˆå¼€å¯ï¼‰
    if (this.sfxEnabled) {
      AudioHelper.playButtonClick();
    }
  }

  // åˆ‡æ¢éœ‡åŠ¨è®¾ç½®
  private toggleVibration(): void {
    this.vibrationEnabled = !this.vibrationEnabled;
    this.saveSettings();
    // æ’­æ”¾æŒ‰é’®éŸ³æ•ˆ
    AudioHelper.playButtonClick();
  }

  // æ˜¾ç¤ºé‡ç½®ç¡®è®¤å¯¹è¯æ¡†
  private showResetConfirmation(): void {
    this.showResetDialog = true;
  }

  // é‡ç½®æ¸¸æˆæ•°æ®
  private resetGameData(): void {
    // TODO: å®žçŽ°é‡ç½®æ¸¸æˆæ•°æ®çš„é€»è¾‘
    // è¿™é‡Œéœ€è¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„æ•°æ®å¹¶é‡æ–°åˆå§‹åŒ–
    this.showResetDialog = false;
    
    // æ˜¾ç¤ºé‡ç½®æˆåŠŸæç¤º
    // TODO: æ·»åŠ æç¤ºç»„ä»¶
  }

  // å–æ¶ˆé‡ç½®
  private cancelReset(): void {
    this.showResetDialog = false;
  }

  // è¿”å›žä¸»èœå•
  private backToMenu(): void {
    this.gameStateManager.changeState(GameStateType.MENU);
    router.back();
  }

  build() {
    Stack() {
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          GameButton({
            text: '',
            icon: 'â†',
            style: ButtonStyle.TRANSPARENT,
            size: ButtonSize.SMALL,
            width: 50,
            height: 50,
            onClick: () => {
              AudioHelper.playButtonClick()
              this.backToMenu()
            }
          })

          Blank()

          Text('è®¾ç½®')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)

          Blank()

          // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
          Column()
            .width(50)
            .height(50)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 20 })

        // è®¾ç½®åˆ—è¡¨
        Scroll() {
          Column({ space: 0 }) {
            // éŸ³é¢‘è®¾ç½®
            GamePanel({
              backgroundColor: 'rgba(255,255,255,0.1)',
              borderRadius: 15,
              padding: 20
            }) {
              Column({ space: 16 }) {
                Row() {
                  GameIcon({ icon: 'ðŸ”Š', size: 24 })
                  Text('éŸ³é¢‘è®¾ç½®')
                    .fontSize(18)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 12 })
                }
                .width('100%')
                
                // èƒŒæ™¯éŸ³ä¹å¼€å…³
                Row() {
                  Text('èƒŒæ™¯éŸ³ä¹')
                    .fontSize(16)
                    .fontColor(Color.White)
                  
                  Blank()
                  
                  Toggle({ type: ToggleType.Switch, isOn: this.musicEnabled })
                    .selectedColor(GameConfig.COLORS.PRIMARY)
                    .onChange((isOn: boolean) => {
                      this.toggleMusic()
                    })
                }
                .width('100%')
                
                // éŸ³æ•ˆå¼€å…³
                Row() {
                  Text('éŸ³æ•ˆ')
                    .fontSize(16)
                    .fontColor(Color.White)
                  
                  Blank()
                  
                  Toggle({ type: ToggleType.Switch, isOn: this.sfxEnabled })
                    .selectedColor(GameConfig.COLORS.PRIMARY)
                    .onChange((isOn: boolean) => {
                      this.toggleSfx()
                    })
                }
                .width('100%')
              }
            }

            // æ¸¸æˆè®¾ç½®
            GamePanel({
              backgroundColor: 'rgba(255,255,255,0.1)',
              borderRadius: 15,
              padding: 20
            }) {
              Column({ space: 16 }) {
                Row() {
                  GameIcon({ icon: 'ðŸŽ®', size: 24 })
                  Text('æ¸¸æˆè®¾ç½®')
                    .fontSize(18)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 12 })
                }
                .width('100%')
                
                // éœ‡åŠ¨åé¦ˆå¼€å…³
                Row() {
                  Text('éœ‡åŠ¨åé¦ˆ')
                    .fontSize(16)
                    .fontColor(Color.White)
                  
                  Blank()
                  
                  Toggle({ type: ToggleType.Switch, isOn: this.vibrationEnabled })
                    .selectedColor(GameConfig.COLORS.PRIMARY)
                    .onChange((isOn: boolean) => {
                      this.toggleVibration()
                    })
                }
                .width('100%')
              }
            }

            // æ•°æ®ç®¡ç†
            GamePanel({
              backgroundColor: 'rgba(255,255,255,0.1)',
              borderRadius: 15,
              padding: 20
            }) {
              Column({ space: 16 }) {
                Row() {
                  GameIcon({ icon: 'ðŸ—‚ï¸', size: 24 })
                  Text('æ•°æ®ç®¡ç†')
                    .fontSize(18)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 12 })
                }
                .width('100%')
                
                // é‡ç½®æ¸¸æˆæ•°æ®æŒ‰é’®
                GameButton({
                  text: 'é‡ç½®æ¸¸æˆæ•°æ®',
                  icon: 'âš ï¸',
                  style: ButtonStyle.WARNING,
                  size: ButtonSize.MEDIUM,
                  width: '100%',
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.showResetConfirmation()
                  }
                })
              }
            }

            // å…³äºŽä¿¡æ¯
            GamePanel({
              backgroundColor: 'rgba(255,255,255,0.1)',
              borderRadius: 15,
              padding: 20
            }) {
              Column({ space: 16 }) {
                Row() {
                  GameIcon({ icon: 'â„¹ï¸', size: 24 })
                  Text('å…³äºŽæ¸¸æˆ')
                    .fontSize(18)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 12 })
                }
                .width('100%')
                
                // æ¸¸æˆç‰ˆæœ¬
                Row() {
                  Text('æ¸¸æˆç‰ˆæœ¬')
                    .fontSize(16)
                    .fontColor(Color.White)
                  
                  Blank()
                  
                  Text('1.0.0')
                    .fontSize(16)
                    .fontColor('#CCCCCC')
                }
                .width('100%')
                
                // æ¸¸æˆä»‹ç»
                Row() {
                  Column({ space: 4 }) {
                    Text('èåœè·‘é…·')
                      .fontSize(16)
                      .fontColor(Color.White)
                      .alignSelf(ItemAlign.Start)
                    
                    Text('ä¸€æ¬¾å¯çˆ±çš„ä¼‘é—²è·‘é…·æ¸¸æˆ')
                      .fontSize(14)
                      .fontColor('#CCCCCC')
                      .alignSelf(ItemAlign.Start)
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  
                  Text('ðŸ¥•')
                    .fontSize(32)
                }
                .width('100%')
              }
            }
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(GameConfig.COLORS.BACKGROUND)

      // é‡ç½®ç¡®è®¤å¯¹è¯æ¡†
      if (this.showResetDialog) {
        Stack() {
          // åŠé€æ˜ŽèƒŒæ™¯
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.7)')
          
          // å¯¹è¯æ¡†é¢æ¿
          GamePanel({
            backgroundColor: 'rgba(255,255,255,0.95)',
            borderRadius: 20,
            padding: 30
          }) {
            Column() {
              // è­¦å‘Šå›¾æ ‡
              GameIcon({ icon: 'âš ï¸', size: 48 })
                .margin({ bottom: 20 })

              Text('é‡ç½®æ¸¸æˆæ•°æ®')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B6B')
                .margin({ bottom: 16 })

              Text('æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰æ¸¸æˆè¿›åº¦ã€è§£é”çš„è§’è‰²ã€é‡‘å¸å’Œæˆå°±ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')
                .fontSize(16)
                .fontColor('#666666')
                .textAlign(TextAlign.Center)
                .lineHeight(24)
                .margin({ bottom: 30 })

              Row({ space: 16 }) {
                GameButton({
                  text: 'å–æ¶ˆ',
                  style: ButtonStyle.SECONDARY,
                  size: ButtonSize.MEDIUM,
                  width: 100,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.cancelReset()
                  }
                })

                GameButton({
                  text: 'ç¡®è®¤é‡ç½®',
                  style: ButtonStyle.WARNING,
                  size: ButtonSize.MEDIUM,
                  width: 120,
                  onClick: () => {
                    AudioHelper.playButtonClick()
                    this.resetGameData()
                  }
                })
              }
            }
          }
          .width(300)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }

  // è®¾ç½®åˆ†ç»„ç»„ä»¶
  @Builder SettingGroup(title: string, items: Array<{
    title: string,
    subtitle?: string,
    value?: boolean,
    isDestructive?: boolean,
    action: () => void
  }>) {
    Column() {
      // åˆ†ç»„æ ‡é¢˜
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 4, bottom: 8, top: 16 })

      // è®¾ç½®é¡¹åˆ—è¡¨
      Column() {
        ForEach(items, (item, index) => {
          Column() {
            Row() {
              Column({ space: 2 }) {
                Text(item.title)
                  .fontSize(16)
                  .fontColor(item.isDestructive ? '#FF4444' : '#333333')
                  .alignSelf(ItemAlign.Start)

                if (item.subtitle) {
                  Text(item.subtitle)
                    .fontSize(12)
                    .fontColor('#888888')
                    .alignSelf(ItemAlign.Start)
                }
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)

              // æŽ§ä»¶åŒºåŸŸ
              if (item.value !== undefined) {
                // å¼€å…³æŽ§ä»¶
                Toggle({ type: ToggleType.Switch, isOn: item.value })
                  .selectedColor(GameConfig.COLORS.PRIMARY)
                  .onChange((isOn: boolean) => {
                    item.action();
                  })
              } else if (!item.isDestructive) {
                // ç®­å¤´æŒ‡ç¤ºå™¨
                Text('>')
                  .fontSize(16)
                  .fontColor('#CCCCCC')
              }
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
            .onClick(() => {
              if (item.value === undefined) {
                item.action();
              }
            })

            // åˆ†éš”çº¿
            if (index < items.length - 1) {
              Divider()
                .color('#EEEEEE')
                .margin({ left: 16, right: 16 })
            }
          }
        })
      }
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 2, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 1 })
    }
  }

  // ä¿¡æ¯åŒºåŸŸç»„ä»¶
  @Builder InfoSection() {
    Column() {
      Text('å…³äºŽæ¸¸æˆ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .alignSelf(ItemAlign.Start)
        .margin({ left: 4, bottom: 8, top: 16 })

      Column() {
        Row() {
          Text('æ¸¸æˆç‰ˆæœ¬')
            .fontSize(16)
            .fontColor('#333333')

          Blank()

          Text('1.0.0')
            .fontSize(16)
            .fontColor('#888888')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })

        Divider()
          .color('#EEEEEE')
          .margin({ left: 16, right: 16 })

        Row() {
          Column({ space: 2 }) {
            Text('èåœè·‘é…·')
              .fontSize(16)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)

            Text('ä¸€æ¬¾å¯çˆ±çš„ä¼‘é—²è·‘é…·æ¸¸æˆ')
              .fontSize(12)
              .fontColor('#888888')
              .alignSelf(ItemAlign.Start)
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          Text('ðŸ¥•')
            .fontSize(24)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .shadow({ radius: 2, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 1 })
    }
  }
}